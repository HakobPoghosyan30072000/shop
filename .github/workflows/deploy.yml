name: Deploy to Vercel

on:
push:
branches:
- main

jobs:
deploy:
runs-on: ubuntu-latest


steps:
  - name: Checkout repository
    uses: actions/checkout@v4

  - name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: '20'
      cache: 'yarn'
      cache-dependency-path: '**/yarn.lock'

  - name: Install dependencies
    run: |
      cd dashboard
      yarn install --frozen-lockfile

  - name: Run ESLint
    run: |
      cd dashboard
      yarn lint

  - name: Run Tests
    run: |
      cd dashboard
      yarn test

  - name: Cache Next.js build
    uses: actions/cache@v3
    with:
      path: dashboard/.next
      key: ${{ runner.os }}-nextjs-${{ hashFiles('dashboard/yarn.lock') }}

  - name: Build project
    run: |
      cd dashboard
      yarn build

  - name: Install Vercel CLI
    run: npm install --global vercel@latest

  - name: Check Vercel Secrets
    run: |
      if [ -z "$VERCEL_TOKEN" ] || [ -z "$VERCEL_PROJECT_ID" ] || [ -z "$VERCEL_ORG_ID" ]; then
        echo "Missing Vercel secrets"
        exit 1
      fi

  - name: Deploy to Vercel
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    run: |
      vercel deploy --prod --yes --token "$VERCEL_TOKEN"
